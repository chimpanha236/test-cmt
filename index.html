<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á“áŸ’á›áŸ‚á„áŸášáŸáŸášáŸá¶ášá‡á¼á“á–áš</title>
    <style>
        /* ášá…á“á¶áŠá¼á…á–á¸á˜á»á“ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; background: linear-gradient(135deg, #ffe8e8, #f9f3f3); padding: 20px; min-height: 100vh; }
        .comment-section { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(255, 107, 107, 0.1); border: 2px solid #ff6b6b; }
        h2, h3 { color: #d32f2f; margin-bottom: 20px; text-align: center; font-family: 'Khmer OS', 'Arial', sans-serif; }
        .comment-form { margin-bottom: 40px; padding: 25px; background: #fff5f5; border-radius: 12px; border: 1px solid #ffcdd2; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #c62828; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #ffcdd2; border-radius: 8px; font-size: 16px; transition: all 0.3s; background: white; }
        input:focus, textarea:focus { outline: none; border-color: #ff6b6b; box-shadow: 0 0 10px rgba(255, 107, 107, 0.2); }
        textarea { resize: vertical; min-height: 120px; }
        .emoji-picker { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .emoji-picker span { font-size: 20px; cursor: pointer; padding: 5px; transition: transform 0.2s; }
        .emoji-picker span:hover { transform: scale(1.2); }
        .submit-btn { background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; padding: 15px 40px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; display: block; margin: 0 auto; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3); }
        .comments-list { border-top: 2px solid #ffcdd2; padding-top: 25px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .comment-item { background: #fff9f9; padding: 20px; margin-bottom: 20px; border-radius: 10px; border-left: 5px solid #ff6b6b; animation: fadeIn 0.5s ease-in; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .comment-header strong { color: #d32f2f; font-size: 18px; }
        .comment-date { color: #ff6b6b; font-size: 14px; }
        .comment-content { color: #333; line-height: 1.6; margin-bottom: 12px; font-size: 16px; }
        .comment-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .delete-btn { background-color: #f44336; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .delete-btn:hover { background-color: #da190b; }
        .success-message { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; border: 1px solid #c3e6cb; }
        .error-message { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; border: 1px solid #f5c6cb; }
        .comment-email { font-size: 14px; color: #666; margin-top: 8px; }
        .no-comments { text-align: center; color: #666; font-style: italic; padding: 20px; }
        .loading { text-align: center; color: #666; padding: 20px; }
        .debug-info { background: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="comment-section">
        <h2>ğŸŠ áŸá¶ášá‡á¼á“á–áš ğŸŠ</h2>

        <div class="success-message" id="successMessage">
            âœ… áŸá¶ášá”á¶á“á”á‰áŸ’á‡á¼á“áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!
        </div>

        <div class="error-message" id="errorMessage">
            âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾áŸá¶áš!
        </div>

        <form class="comment-form" id="commentForm">
            <div class="form-group">
                <label for="name">áˆáŸ’á˜áŸ„áŸ‡ *â€‹</label>
                <input type="text" id="name" name="name" required placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€...">
            </div>
            
            <div class="form-group">
                <label for="email">á¢áŸŠá¸á˜áŸ‚á›</label>
                <input type="email" id="email" name="email" placeholder="á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‚á›ášá”áŸáŸ‹á¢áŸ’á“á€...">
            </div>
            
            <div class="form-group">
                <label for="comment">áŸá¶ášá‡á¼á“á–áš *</label>
                <div class="emoji-picker">
                    <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span>
                    <span onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
                    <span onclick="addEmoji('ğŸ‰')">ğŸ‰</span>
                    <span onclick="addEmoji('ğŸ¥³')">ğŸ¥³</span>
                    <span onclick="addEmoji('ğŸ™')">ğŸ™</span>
                </div>
                <textarea id="comment" name="comment" rows="5" required placeholder="áŸá¼á˜áŸášáŸáŸášáŸá¶ášá‡á¼á“á–ášášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡..."></textarea>
            </div>
            
            <button type="submit" class="submit-btn">ğŸ“¨ á•áŸ’á‰á¾áŸá¶ášá‡á¼á“á–áš</button>
        </form>
        
        <div class="comments-list" id="commentsList">
            <h3>ğŸ’Œ áŸá¶ášá‡á¼á“á–ášáŠáŸ‚á›á”á¶á“á•áŸ’á‰á¾ášá½á…</h3>
            <div class="loading" id="loadingMessage">
                ğŸ”„ á€áŸ†á–á»á„á•áŸ’á‘á»á€áŸá¶ášá‡á¼á“á–áš...
            </div>
            <div class="no-comments" id="noComments" style="display: none;">
                á˜á·á“á‘á¶á“áŸ‹á˜á¶á“áŸá¶ášá‡á¼á“á–ášá“áŸ…á¡á¾á™á‘áŸáŸ” áŸá¼á˜á•áŸ’á‰á¾áŸá¶ášá‡á¼á“á–ášášá”áŸáŸ‹á¢áŸ’á“á€á˜á€á‡á¶á˜á»á“áŸá·á“!
            </div>
        </div>

        <!-- Debug Information -->
        <div class="debug-info" id="debugInfo" style="display: none;">
            <strong>Debug Information:</strong>
            <div id="debugContent"></div>
        </div>
    </div>

    <!-- Firebase SDK Version 9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, where, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_tEDufGFMQRbnV34gkk5w2pEY7Eqysyk",
            authDomain: "test-cmt-2.firebaseapp.com",
            projectId: "test-cmt-2",
            storageBucket: "test-cmt-2.firebasestorage.app",
            messagingSenderId: "586264056540",
            appId: "1:586264056540:web:33a752e8f5aee76d255a19",
            measurementId: "G-GHEG5ZR4FY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Debug function
        function showDebugInfo(message) {
            console.log('DEBUG:', message);
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            debugContent.textContent = message;
            debugInfo.style.display = 'block';
        }

        // Show error message
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = 'âŒ ' + message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            showDebugInfo('á€áŸ†á–á»á„á…á¶á”áŸ‹á•áŸ’áŠá¾á˜...');
            
            const commentForm = document.getElementById('commentForm');
            const successMessage = document.getElementById('successMessage');

            // Test Firebase connection
            try {
                showDebugInfo('á€áŸ†á–á»á„ááŸáŸáŸ’áá€á¶ášá—áŸ’á‡á¶á”áŸ‹ Firebase...');
                const testQuery = query(collection(db, "weddingComments"), limit(1));
                await getDocs(testQuery);
                showDebugInfo('Firebase á—áŸ’á‡á¶á”áŸ‹á”á¶á“á‡áŸ„á‚á‡áŸá™!');
            } catch (error) {
                showDebugInfo('á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá—áŸ’á‡á¶á”áŸ‹ Firebase: ' + error.message);
                showError('á˜á·á“á¢á¶á…á—áŸ’á‡á¶á”áŸ‹á‘áŸ…á€á¶á“áŸ‹ database á”á¶á“: ' + error.message);
                return;
            }

            // Load comments
            await loadCommentsFromFirebase();

            commentForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const comment = document.getElementById('comment').value.trim();
                
                if (name && comment) {
                    const submitBtn = commentForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'á€áŸ†á–á»á„á•áŸ’á‰á¾...';
                    
                    showDebugInfo('á€áŸ†á–á»á„á•áŸ’á‰á¾áŸá¶áš: ' + name);
                    
                    try {
                        const success = await addCommentToFirebase(name, email, comment);
                        
                        if (success) {
                            commentForm.reset();
                            showSuccessMessage();
                            showDebugInfo('áŸá¶ášá”á¶á“á•áŸ’á‰á¾áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!');
                            await loadCommentsFromFirebase();
                        } else {
                            showError('á˜á·á“á¢á¶á…á•áŸ’á‰á¾áŸá¶ášá”á¶á“');
                        }
                    } catch (error) {
                        showDebugInfo('á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾áŸá¶áš: ' + error.message);
                        showError('á€áŸ†á á»áŸ: ' + error.message);
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ“¨ á•áŸ’á‰á¾áŸá¶ášá‡á¼á“á–áš';
                } else {
                    showError('áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„áŸá¶ášá‡á¼á“á–áš!');
                }
            });
        });

        async function addCommentToFirebase(name, email, comment) {
            try {
                showDebugInfo('á€áŸ†á–á»á„á”á“áŸ’ááŸ‚á˜áŸá¶ášá‘áŸ…á€á¶á“áŸ‹ Firebase...');
                
                const docRef = await addDoc(collection(db, "weddingComments"), {
                    name: name,
                    email: email,
                    comment: comment,
                    timestamp: serverTimestamp(),
                    approved: true
                });
                
                showDebugInfo('áŸá¶ášááŸ’ášá¼áœá”á¶á“á”á“áŸ’ááŸ‚á˜áŠáŸ„á™á‡áŸ„á‚á‡áŸá™! ID: ' + docRef.id);
                return true;
            } catch (error) {
                showDebugInfo('á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá”á“áŸ’ááŸ‚á˜áŸá¶áš: ' + error.message);
                console.error('Error details:', error);
                return false;
            }
        }

        async function loadCommentsFromFirebase() {
            try {
                showDebugInfo('á€áŸ†á–á»á„á•áŸ’á‘á»á€áŸá¶ášá–á¸ Firebase...');
                
                const q = query(
                    collection(db, "weddingComments"), 
                    orderBy("timestamp", "desc"),
                    limit(100)
                );
                
                const querySnapshot = await getDocs(q);
                const loadingMessage = document.getElementById('loadingMessage');
                const noComments = document.getElementById('noComments');
                
                // Clear old comments
                const oldComments = document.querySelectorAll('.comment-item');
                oldComments.forEach(comment => comment.remove());
                
                loadingMessage.style.display = 'none';
                
                if (querySnapshot.empty) {
                    noComments.style.display = 'block';
                    showDebugInfo('á˜á·á“á˜á¶á“áŸá¶ášáá¶á˜á½á™á“áŸ…á€áŸ’á“á»á„ database');
                    return;
                }
                
                noComments.style.display = 'none';
                showDebugInfo('ášá€áƒá¾á‰ ' + querySnapshot.size + ' áŸá¶áš');
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    displayComment({
                        id: doc.id,
                        name: data.name,
                        email: data.email,
                        comment: data.comment,
                        date: data.timestamp?.toDate() || new Date()
                    });
                });
                
            } catch (error) {
                showDebugInfo('á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá•áŸ’á‘á»á€áŸá¶áš: ' + error.message);
                console.error('Error details:', error);
                
                const loadingMessage = document.getElementById('loadingMessage');
                const noComments = document.getElementById('noComments');
                
                loadingMessage.style.display = 'none';
                noComments.textContent = 'á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‘á»á€áŸá¶ášá‡á¼á“á–áš: ' + error.message;
                noComments.style.display = 'block';
                
                showError('á˜á·á“á¢á¶á…á•áŸ’á‘á»á€áŸá¶ášá”á¶á“: ' + error.message);
            }
        }

        function displayComment(commentData) {
            const commentsList = document.getElementById('commentsList');
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.id = commentData.id;
            
            const dateString = commentData.date.toLocaleDateString('km-KH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <strong>${escapeHtml(commentData.name)}</strong>
                    <span class="comment-date">${dateString}</span>
                </div>
                <p class="comment-content">${escapeHtml(commentData.comment)}</p>
                ${commentData.email ? `<div class="comment-email">á¢áŸŠá¸á˜áŸ‚á›: ${escapeHtml(commentData.email)}</div>` : ''}
                <div class="comment-actions">
                    <button class="delete-btn" onclick="deleteComment('${commentData.id}')">á›á»á”</button>
                </div>
            `;
            
            const commentsTitle = commentsList.querySelector('h3');
            commentsList.insertBefore(commentItem, commentsTitle.nextSibling);
        }

        window.deleteComment = async function(commentId) {
            if (confirm('áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”áŸá¶ášá‡á¼á“á–ášá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?')) {
                try {
                    await deleteDoc(doc(db, "weddingComments", commentId));
                    document.getElementById(commentId).remove();
                    
                    const comments = document.querySelectorAll('.comment-item');
                    if (comments.length === 0) {
                        document.getElementById('noComments').style.display = 'block';
                    }
                    
                    showDebugInfo('áŸá¶ášááŸ’ášá¼áœá”á¶á“á›á»á”áŠáŸ„á™á‡áŸ„á‚á‡áŸá™');
                } catch (error) {
                    showDebugInfo('á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá›á»á”áŸá¶áš: ' + error.message);
                    showError('á˜á·á“á¢á¶á…á›á»á”áŸá¶ášá”á¶á“');
                }
            }
        }

        function showSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        window.addEmoji = function(emoji) {
            const textarea = document.getElementById('comment');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const newText = text.substring(0, start) + emoji + text.substring(end);
            
            textarea.value = newText;
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>

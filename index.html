<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á“áŸ’á›áŸ‚á„áŸášáŸáŸášáŸá¶ášá‡á¼á“á–áš</title>
    <style>
        /* ášá…á“á¶áŠá¼á…á–á¸á˜á»á“ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #ffe8e8, #f9f3f3);
            padding: 20px;
            min-height: 100vh;
        }

        .comment-section {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.1);
            border: 2px solid #ff6b6b;
        }

        h2, h3 {
            color: #d32f2f;
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Khmer OS', 'Arial', sans-serif;
        }

        .comment-form {
            margin-bottom: 40px;
            padding: 25px;
            background: #fff5f5;
            border-radius: 12px;
            border: 1px solid #ffcdd2;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #c62828;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffcdd2;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .emoji-picker {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .emoji-picker span {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .emoji-picker span:hover {
            transform: scale(1.2);
        }

        .submit-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: block;
            margin: 0 auto;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .comments-list {
            border-top: 2px solid #ffcdd2;
            padding-top: 25px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .comment-item {
            background: #fff9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 5px solid #ff6b6b;
            position: relative;
            animation: fadeIn 0.5s ease-in;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .comment-header strong {
            color: #d32f2f;
            font-size: 18px;
        }

        .comment-date {
            color: #ff6b6b;
            font-size: 14px;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background-color: #da190b;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            border: 1px solid #c3e6cb;
        }

        .comment-email {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        .no-comments {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .comment-section {
                padding: 20px;
                margin: 10px;
            }
            
            .comment-form {
                padding: 20px;
            }
            
            .comment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="comment-section">
        <h2>ğŸŠ áŸá¶ášá‡á¼á“á–áš ğŸŠ</h2>

        <div class="success-message" id="successMessage">
            âœ… áŸá¶ášá”á¶á“á”á‰áŸ’á‡á¼á“áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!
        </div>

        <form class="comment-form" id="commentForm">
            <div class="form-group">
                <label for="name">áˆáŸ’á˜áŸ„áŸ‡ *â€‹</label>
                <input type="text" id="name" name="name" required placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€...">
            </div>
            
            <div class="form-group">
                <label for="email">á¢áŸŠá¸á˜áŸ‚á›</label>
                <input type="email" id="email" name="email" placeholder="á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‚á›ášá”áŸáŸ‹á¢áŸ’á“á€...">
            </div>
            
            <div class="form-group">
                <label for="comment">áŸá¶ášá‡á¼á“á–áš *</label>
                <div class="emoji-picker">
                    <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span>
                    <span onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
                    <span onclick="addEmoji('ğŸ‰')">ğŸ‰</span>
                    <span onclick="addEmoji('ğŸ¥³')">ğŸ¥³</span>
                    <span onclick="addEmoji('ğŸ™')">ğŸ™</span>
                </div>
                <textarea id="comment" name="comment" rows="5" required placeholder="áŸá¼á˜áŸášáŸáŸášáŸá¶ášá‡á¼á“á–ášášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡..."></textarea>
            </div>
            
            <button type="submit" class="submit-btn">ğŸ“¨ á•áŸ’á‰á¾áŸá¶ášá‡á¼á“á–áš</button>
        </form>
        
        <div class="comments-list" id="commentsList">
            <h3>ğŸ’Œ áŸá¶ášá‡á¼á“á–ášáŠáŸ‚á›á”á¶á“á•áŸ’á‰á¾ášá½á…</h3>
            <div class="loading" id="loadingMessage">
                ğŸ”„ á€áŸ†á–á»á„á•áŸ’á‘á»á€áŸá¶ášá‡á¼á“á–áš...
            </div>
            <div class="no-comments" id="noComments" style="display: none;">
                á˜á·á“á‘á¶á“áŸ‹á˜á¶á“áŸá¶ášá‡á¼á“á–ášá“áŸ…á¡á¾á™á‘áŸáŸ” áŸá¼á˜á•áŸ’á‰á¾áŸá¶ášá‡á¼á“á–ášášá”áŸáŸ‹á¢áŸ’á“á€á˜á€á‡á¶á˜á»á“áŸá·á“!
            </div>
        </div>
    </div>

    <!-- Firebase SDK Version 9 -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, where, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_tEDufGFMQRbnV34gkk5w2pEY7Eqysyk",
            authDomain: "test-cmt-2.firebaseapp.com",
            projectId: "test-cmt-2",
            storageBucket: "test-cmt-2.firebasestorage.app",
            messagingSenderId: "586264056540",
            appId: "1:586264056540:web:33a752e8f5aee76d255a19",
            measurementId: "G-GHEG5ZR4FY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ááŸ’ášáŸ€á˜ááŸ’á›á½á“áŸá˜áŸ’ášá¶á”áŸ‹á”áŸ’ášá¾á€áŸ’á“á»á„ global scope
        window.db = db;
        window.firestoreFunctions = {
            collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, where, serverTimestamp, limit
        };

        document.addEventListener('DOMContentLoaded', function() {
            const commentForm = document.getElementById('commentForm');
            const successMessage = document.getElementById('successMessage');
            const loadingMessage = document.getElementById('loadingMessage');
            const noComments = document.getElementById('noComments');

            // á•áŸ’á‘á»á€ comments á–á¸ Firebase
            loadCommentsFromFirebase();

            commentForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const comment = document.getElementById('comment').value.trim();
                
                if (name && comment) {
                    const submitBtn = commentForm.querySelector('.submit-btn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'á€áŸ†á–á»á„á•áŸ’á‰á¾...';
                    
                    // á•áŸ’á‰á¾á‘áŸ… Firebase
                    const success = await addCommentToFirebase(name, email, comment);
                    
                    if (success) {
                        commentForm.reset();
                        showSuccessMessage();
                        // á•áŸ’á‘á»á€ comments á¡á¾á„áœá·á‰
                        await loadCommentsFromFirebase();
                    } else {
                        alert('á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‰á¾áŸá¶áš! áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€ááŸ”');
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ“¨ á•áŸ’á‰á¾áŸá¶ášá‡á¼á“á–áš';
                } else {
                    alert('áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„áŸá¶ášá‡á¼á“á–áš!');
                }
            });
        });

        // á˜á»áá„á¶ášá”á“áŸ’ááŸ‚á˜ comment á‘áŸ… Firebase
        async function addCommentToFirebase(name, email, comment) {
            try {
                await addDoc(collection(db, "weddingComments"), {
                    name: name,
                    email: email,
                    comment: comment,
                    timestamp: serverTimestamp(),
                    approved: true
                });
                return true;
            } catch (error) {
                console.error('Error adding comment:', error);
                return false;
            }
        }

        // á˜á»áá„á¶ášá‘á¶á‰á™á€ comments á–á¸ Firebase
        async function loadCommentsFromFirebase() {
            try {
                const q = query(
                    collection(db, "weddingComments"), 
                    where("approved", "==", true),
                    orderBy("timestamp", "desc"),
                    limit(100)
                );
                
                const querySnapshot = await getDocs(q);
                const loadingMessage = document.getElementById('loadingMessage');
                const noComments = document.getElementById('noComments');
                
                // áŸáŸ†á¢á¶á comments á…á¶áŸáŸ‹
                const oldComments = document.querySelectorAll('.comment-item');
                oldComments.forEach(comment => comment.remove());
                
                loadingMessage.style.display = 'none';
                
                if (querySnapshot.empty) {
                    noComments.style.display = 'block';
                    return;
                }
                
                noComments.style.display = 'none';
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    displayComment({
                        id: doc.id,
                        name: data.name,
                        email: data.email,
                        comment: data.comment,
                        date: data.timestamp?.toDate() || new Date()
                    });
                });
                
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('noComments').textContent = 'á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá•áŸ’á‘á»á€áŸá¶ášá‡á¼á“á–áš!';
                document.getElementById('noComments').style.display = 'block';
            }
        }

        // á˜á»áá„á¶ášá”á„áŸ’á á¶á‰ comment
        function displayComment(commentData) {
            const commentsList = document.getElementById('commentsList');
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.id = commentData.id;
            
            const dateString = commentData.date.toLocaleDateString('km-KH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <strong>${escapeHtml(commentData.name)}</strong>
                    <span class="comment-date">${dateString}</span>
                </div>
                <p class="comment-content">${escapeHtml(commentData.comment)}</p>
                ${commentData.email ? `<div class="comment-email">á¢áŸŠá¸á˜áŸ‚á›: ${escapeHtml(commentData.email)}</div>` : ''}
                <div class="comment-actions">
                    <button class="delete-btn" onclick="deleteComment('${commentData.id}')">á›á»á”</button>
                </div>
            `;
            
            const commentsTitle = commentsList.querySelector('h3');
            commentsList.insertBefore(commentItem, commentsTitle.nextSibling);
        }

        // á˜á»áá„á¶ášá›á»á” comment
        window.deleteComment = async function(commentId) {
            if (confirm('áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”áŸá¶ášá‡á¼á“á–ášá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?')) {
                try {
                    await deleteDoc(doc(db, "weddingComments", commentId));
                    document.getElementById(commentId).remove();
                    
                    // á–á·á“á·ááŸ’á™á˜á¾á›á”á¾á‚áŸ’á˜á¶á“ comments á‘áŸ€áá‘áŸ
                    const comments = document.querySelectorAll('.comment-item');
                    if (comments.length === 0) {
                        document.getElementById('noComments').style.display = 'block';
                    }
                    
                    alert('áŸá¶ášá‡á¼á“á–ášááŸ’ášá¼áœá”á¶á“á›á»á”áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!');
                } catch (error) {
                    alert('á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá›á»á”áŸá¶áš!');
                }
            }
        }

        // á˜á»áá„á¶ášá‡á½á™á•áŸ’áŸáŸá„áŸ—
        function showSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        window.addEmoji = function(emoji) {
            const textarea = document.getElementById('comment');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const newText = text.substring(0, start) + emoji + text.substring(end);
            
            textarea.value = newText;
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
